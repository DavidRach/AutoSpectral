---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# AutoSpectral

<!-- badges: start -->
<!-- badges: end -->

AutoSpectral is AutoSpill updated for the spectral flow era.

The goal of AutoSpectral is to provide you with the best possible spectral 
signatures of the fluorophores in your single-stained controls. Whether or not
these accurately model your fully stained samples will depend on what you've 
chosen to use for the controls, how they were prepared and other factors such
as any divergence in handling between samples and controls as well as machine
variation. 

More to the point, AutoSpectral is intended to make working with messy cell-based
controls as easy as compensation beads. This should give you better accuracy
and precision in your spectral definition and thus in your unmixing.

At the moment, the following cytometers are supported:

* Cytek Aurora/Northern Lights ("aurora")
* Sony ID7000 ("id7000")
* BD FACSDiscoverS8 ("s8")
* BD FACSDiscoverA8 ("a8")
* Agilent NovoCyte Opteon ("opteon")

There will likely be some unresolved issues with plotting data from certain 
configurations of the ID7000 and Aurora. Please note that FCS 3.2 files from the
S8 and A8 cytometers are not fully supported in flowCore. You may receive 
warnings, but things should still work.

If you want to use data from another cytometer and are wiling to provide files 
for establishing the workflow, contact the author/maintainer.

This work has received funding from the KU Leuven C1 program, the European Unionâ€™s 
Horizon 2020 research and innovation programme under grant agreement No 874707 
(EXIMIOUS), Wellcome Investigator Award, 222442/A/21/Z and UKRI Proactive 
Vaccinology Award, MR/Y004450/1 (IMMPROVE).

AutoSpectral is provided under a GPL3 licence for academic use. If you wish to
use AutoSpectral in a non-academic setting, please contact Adrian Liston 
regarding licencing options.

## Installation

You can install the development version of AutoSpectral from [GitHub](https://github.com/) with:

``` {r, eval = FALSE}

# Install missing Bioconductor packages
if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install(c("flowWorkspace", "flowCore", "PeacoQC", "Biobase"))

# install.packages("devtools")
devtools::install_github("DrCytometer/AutoSpectral")
```

## Example

This is a basic example of the workflow, using samples from the ID7000:

```{r, eval = FALSE}
library( AutoSpectral )

# define the location of the single-stained control files
control.dir <- "./Cell controls"

# get the parameters for your cytometer
# supported cytometers include "aurora", "id7000", "a8", "s8" and "opteon"
asp <- get.autospectral.param( cytometer = "id7000", figures = TRUE )

# optionally, create a control file
# after creating it, manually edit to ensure it is correct
create.control.file( control.dir, asp )

# load the edited control file
control.def.file <- "fcs_control_file.csv"

# adjustments to automated gating
# this will be covered more extensively elsewhere
# in this case, the cells on scatter are very small, so we modify the target
asp$gate.bound.density.max.target.cells <- 0

# load the control files, gate, prepare for spectral extraction
# this is usually the slowest step
flow.control <- define.flow.control( control.dir, control.def.file, asp )

# for speed and accuracy, cleaning the controls by using scatter-matched universal
# negatives are recommended for both beads and cells
clean.controls( flow.control, asp, universal.negative = TRUE, downsample = TRUE,
                scatter.match = TRUE )

# extract the clean spectra
univ.neg.spectra <- get.fluorophore.spectra( flow.control, asp, 
                                            use.clean.expr = TRUE,
                                            plot.prefix = "Universal Negative Cells" )

# by default AutoSpectral extracts autofluorescence as a spectrum
# to remove this for unmixing:
no.af.spectra <- univ.neg.spectra[ ! rownames( univ.neg.spectra ) == "AF", ]

## unmixing
# set the location of the raw files to be unmixed
sample.dir <- "./Raw samples"

# perform unmixing, here we will unmix all fcs files in the folder using wls
unmix.folder( sample.dir, no.af.spectra, asp, flow.control, method = "WLS" )


```


