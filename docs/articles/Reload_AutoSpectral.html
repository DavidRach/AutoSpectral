<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Re-running_AutoSpectral • AutoSpectral</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Re-running_AutoSpectral">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">AutoSpectral</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.7.8</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Aurora_example.html">Aurora_example</a>
    </li>
    <li>
      <a href="../articles/Cleaning.html">Cleaning</a>
    </li>
    <li>
      <a href="../articles/Control_File_example.html">Control_File_example</a>
    </li>
    <li>
      <a href="../articles/Gating.html">Gating</a>
    </li>
    <li>
      <a href="../articles/Per_Cell_Optimization.html">Per Cell Optimization</a>
    </li>
    <li>
      <a href="../articles/Plotting.html">Plotting</a>
    </li>
    <li>
      <a href="../articles/Reload_AutoSpectral.html">Re-running_AutoSpectral</a>
    </li>
    <li>
      <a href="../articles/Single_Cell_AutoFluorescence.html">Single Cell Autofluorescence</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/DrCytometer/AutoSpectral/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Re-running_AutoSpectral</h1>
            
            <h4 data-toc-skip class="date">2025-07-10</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/DrCytometer/AutoSpectral/blob/HEAD/vignettes/articles/Reload_AutoSpectral.Rmd" class="external-link"><code>vignettes/articles/Reload_AutoSpectral.Rmd</code></a></small>
      <div class="hidden name"><code>Reload_AutoSpectral.Rmd</code></div>

    </div>

    
    
<p>In this article, we’ll cover some shortcuts to allow you to return to
AutoSpectral once you’ve already run an experiment. You may wish to
return to an experiment to unmix it again. If you want to create new
spectra, perhaps trying a new cleaning method or changing the gating,
start as you would normally. If however, all you want to do is re-unmix
or change the parameter names on the created FCS files, you don’t need
to go through the whole process of loading the single-stained control
files, gating, cleaning and extracting the spectra. In this article,
we’re going to look at the short, quick workflow to allow you to return
to a previous AutoSpectral run and go straight to unmixing. Note that
this workflow can be adapted to use spectral matrices obtained using
other methods, such as FlowJo or SpectroFlo, if you prefer. Some details
on that at the end.</p>
<p>We’re going to start, as always, by loading AutoSpectral and setting
the parameters for our cytometer. We also need the folder containing the
single-stained controls and the control file spreadsheet. You should
already have all of this.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DrCytometer/AutoSpectral" class="external-link">AutoSpectral</a></span><span class="op">)</span></span>
<span><span class="va">asp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.autospectral.param.html">get.autospectral.param</a></span><span class="op">(</span>cytometer <span class="op">=</span> <span class="st">"id7000"</span><span class="op">)</span></span>
<span><span class="va">control.dir</span> <span class="op">&lt;-</span> <span class="st">"path_to_my_single_stained_controls"</span></span>
<span><span class="va">control.def.file</span> <span class="op">&lt;-</span> <span class="st">"fcs_control_file.csv"</span></span></code></pre></div>
<p>Then, we create a shell of the <code>flow.control</code> list, mostly
to provide us with the channels we’ll use for spectral unmixing.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flow.control</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reload.flow.control.html">reload.flow.control</a></span><span class="op">(</span><span class="va">control.dir</span>, <span class="va">control.def.file</span>, <span class="va">asp</span><span class="op">)</span></span></code></pre></div>
<p>We also need to load in our spectra. If we’ve run AutoSpectral
already, these will be in <code>./table_spectra</code> and will, by
default, be called something like “Initial autospectral spectra.csv”. We
need to read this into R. For this, there’s a very simple helper
function that reads the named CSV file and sets the structure back as it
was when written. If your file isn’t in that folder, use the
<code>spectra.dir</code> argument to define the location.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spectra.file</span> <span class="op">&lt;-</span> <span class="st">"Initial autospectral spectra.csv"</span></span>
<span><span class="va">spectral.matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read.spectra.html">read.spectra</a></span><span class="op">(</span><span class="va">spectra.file</span><span class="op">)</span></span></code></pre></div>
<p>There’s an option in <code>read.spectra</code> to remove the
autofluorescence <code>AF</code> parameter while reading in. For this,
set <code>remove.af</code> to <code>TRUE</code>. Note that you can
change which fluorophore(s) are excluded by naming them to the
<code>af.param</code> argument.</p>
<p>Now, we have all the information we need to unmix our files. We just
need to point AutoSpectral to the folder containing the FCS files we
want to unmix and tell it how we want to perform the unmixing. Here,
we’re using weighted least squares by calling <code>WLS</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sample.dir</span> <span class="op">&lt;-</span> <span class="st">"./Raw samples"</span></span>
<span><span class="fu"><a href="../reference/unmix.folder.html">unmix.folder</a></span><span class="op">(</span> <span class="va">sample.dir</span>, <span class="va">spectral.matrix</span>, <span class="va">asp</span>, <span class="va">flow.control</span>, method <span class="op">=</span> <span class="st">"WLS"</span> <span class="op">)</span></span></code></pre></div>
<p>The unmixed FCS files go to the “AutoSpectral_unmixed” folder in your
current working directory, or, if you prefer, to the folder of your
choice if you specify this to unmix.folder as an argument to
<code>output.dir</code>.</p>
<hr>
<p>You can also load a spectral matrix you’ve prepared using something
else. For instance, we can spectra that we isolate in FlowJo or directly
pull them from the SpectroFlo Experiment file. Why would you want to do
this? Well, perhaps you’re struggling with AutoSpectral and know you can
get decent spectra from your beads in FlowJo or know that you’ve already
gotten clean spectra on your cytometer’s software. Maybe you’d just like
to try out different unmixing approaches, perhaps checking the per-cell
autofluorescence extraction. Let’s look at how to do this.</p>
<p>You’ll need to run the steps above up to the point of loading in the
spectra. In other words, you need to create <code>asp</code>,
<code>control.dir</code>, <code>control.def.file</code> and
<code>flow.control</code>. Hopefully this can be simplified in the
future.</p>
<p>Now, to load in a matrix from FlowJo, first create it using the
Spectral Population Viewer tool. Use negative and positive gating, as
appropriate for your sample. <a href="https://docs.flowjo.com/flowjo/advanced-features/spectral-populations/" class="external-link uri">https://docs.flowjo.com/flowjo/advanced-features/spectral-populations/</a></p>
<div class="float">
<img src="figures/FlowJo_Spectral_Viewer.jpg" alt="FlowJo Spectral Viewer"><div class="figcaption">FlowJo Spectral Viewer</div>
</div>
<p>To get the spectral (spillover) data, first set the Spectral Viewer
Plot to normalized values by going to Options/Normalized/Only Positive
Values. Then, right click on the plot and “Copy Content”. Paste this
into your favorite spreadsheet program (e.g., Excel), which will
probably give you a mess like this:</p>
<div class="float">
<img src="figures/FlowJo_matrix_formatting.png" alt="FlowJo Matrix Formatting"><div class="figcaption">FlowJo Matrix Formatting</div>
</div>
<div class="float">
<img src="figures/Reformatted_FlowJo_Matrix.jpg" alt="FlowJo Matrix Formatting"><div class="figcaption">FlowJo Matrix Formatting</div>
</div>
<p>To reformat it, click on the clipboard icon and select “Use Text
Import Wizard”. Select “delimited”, hit “Next”, then select “Comma” and
finally “Finish”.</p>
<div class="float">
<img src="figures/Text_import_wizard.jpg" alt="Text Import Wizard"><div class="figcaption">Text Import Wizard</div>
</div>
<div class="float">
<img src="figures/Reformatted_FlowJo_Matrix.jpg" alt="FlowJo Matrix Reformatted"><div class="figcaption">FlowJo Matrix Reformatted</div>
</div>
<p>The spectra are normalized to 100 in FlowJo, whereas in AutoSpectral
and in SpectroFlo everything is normalized to 1. You’ll need to
re-normalize to 1 (i.e., divide by 100) if you want to use this for
unmixing. If you start combining data from different sources with
different normalization schemes, re-normalize before unmixing or the
normalization will carry over into the scaling of the unmixed data,
which you don’t want. This renormalization happens automatically if you
use the read.spectra function below.</p>
<p>You should probably rename the stuff in column A to be the names of
the fluorophores, as this is what you’ll be importing into R.</p>
<p>Save the spreadsheet as a CSV file. Then you can read it into R as
follows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spectra.file</span> <span class="op">&lt;-</span> <span class="st">"FlowJo_Spectra.csv"</span></span>
<span><span class="va">flowjo.spectra</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read.spectra.html">read.spectra</a></span><span class="op">(</span><span class="va">spectra.file</span>, spectra.dir <span class="op">=</span> <span class="st">"~/AutoSpectral_data/AlternativeMatrices/"</span><span class="op">)</span></span>
<span><span class="va">flowjo.spectra</span></span></code></pre></div>
<p>Pulling the spillover matrix directly from your SpectroFlo experiment
is also possible, provided you’ve gone through the unmixing process in
SpectroFlo. This should work whether you’ve used controls as part of a
Reference Group or used stored controls from the library. In other
words, we can obtain the spillover matrix that was used for the unmixing
in SpectroFlo.</p>
<p>List the name and location of your experiment file. The function will
extract the spillover matrix both to an object in R as well as writing a
copy to disk as a CSV file. Define where you’d like the CSV file to end
up as <code>output.dir</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spectroflo.expt</span> <span class="op">&lt;-</span> <span class="st">"~/AutoSpectral_data/AlternativeMatrices/20240620 Spectral Symposium-poor cell unmixed.Expt"</span></span>
<span><span class="va">output.dir</span> <span class="op">&lt;-</span> <span class="st">"./table_spectra"</span></span>
<span><span class="va">spectral.matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read.spectroflo.expt.html">read.spectroflo.expt</a></span><span class="op">(</span><span class="va">spectroflo.expt</span>, <span class="va">output.dir</span><span class="op">)</span></span>
<span><span class="va">spectral.matrix</span></span></code></pre></div>
<p>Note: this sometimes gives odd spectra. Check by plotting
<code>spectral.trace</code> or <code>spectral.heatmap</code>. I suspect
this happens if you re-import the experiment into an
non-cytometer-connected version of SpectroFlo, but I need to look into
it a bit more.</p>
<p>For BD instruments, the spectra are stored correctly in the
<code>SPILL</code> keyword in the unmixed flow files. So, these should
be in any FCS file from the A8 or S8 that is not a single-stained
control and where you have run the unmixing in Chorus.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s8.fcs</span> <span class="op">&lt;-</span> <span class="st">"~/AutoSpectral_data/S8_data/BP0323502_1.fcs"</span></span>
<span><span class="va">chorus.spectra</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read.bd.spectra.html">read.bd.spectra</a></span><span class="op">(</span><span class="va">s8.fcs</span><span class="op">)</span></span>
<span><span class="va">chorus.spectra</span></span></code></pre></div>
<p>A plea to instrument manufacturers: Please, please start doing what
BD is doing. Including the fluorophore spectra used for the unmixing
calculation in the FCS file provides really important information for QC
and reproducibility.</p>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Oliver Burton, Carlos P. Roca.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
