<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tools for Unmxing Spectral Flow Cytometry Data • AutoSpectral</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Tools for Unmxing Spectral Flow Cytometry Data">
<meta property="og:description" content="Isolates and refines clean spectral signatures from single stained controls. Deals with autofluorescence contamination in controls effectively. Unmix fcs files with ordinary or weighted least squares, or with the hallmark AutoSpectral approach to deal with autofluorescence on a per-cell basis.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">AutoSpectral</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.7.8</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/Aurora_example.html">Aurora_example</a>
    </li>
    <li>
      <a href="articles/Cleaning.html">Cleaning</a>
    </li>
    <li>
      <a href="articles/Control_File_example.html">Control_File_example</a>
    </li>
    <li>
      <a href="articles/Gating.html">Gating</a>
    </li>
    <li>
      <a href="articles/Per_Cell_Optimization.html">Per Cell Optimization</a>
    </li>
    <li>
      <a href="articles/Plotting.html">Plotting</a>
    </li>
    <li>
      <a href="articles/Reload_AutoSpectral.html">Re-running_AutoSpectral</a>
    </li>
    <li>
      <a href="articles/Single_Cell_AutoFluorescence.html">Single Cell Autofluorescence</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/DrCytometer/AutoSpectral/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="contents col-md-9">
<div class="section level1">
<div class="page-header"><h1 id="autospectral">AutoSpectral<a class="anchor" aria-label="anchor" href="#autospectral"></a>
</h1></div>
<!-- badges: start -->
<!-- badges: end -->
<p>AutoSpectral is AutoSpill updated for the spectral flow era.</p>
<p>It is also pretty complex and newly released, so there will be bugs. Sorry. Please read the help pages and articles before submitting bug reports. There’s a lot of info there.</p>
<p>The goal of AutoSpectral is to provide you with the best possible spectral signatures of the fluorophores in your single-stained controls. Whether or not these accurately model your fully stained samples will depend on what you’ve chosen to use for the controls, how they were prepared and other factors such as machine condition and any divergence in handling between samples and controls.</p>
<p>More to the point, AutoSpectral is intended to make working with messy cell-based controls as easy as compensation beads. This should give you better accuracy and precision in your spectral definition and thus in your unmixing.</p>
<p>Plus, you can extract each cell’s individual autofluorescent background in a manner specific to that cell, producing better unmixing with less spread.</p>
<p>At the moment, the following cytometers are supported:</p>
<ul>
<li>Cytek Aurora/Northern Lights (“aurora”)</li>
<li>Sony ID7000 (“id7000”)</li>
<li>BD FACSDiscoverS8 (“s8”)</li>
<li>BD FACSDiscoverA8 (“a8”)</li>
<li>Agilent NovoCyte Opteon (“opteon”)</li>
</ul>
<p>There will likely be some unresolved issues with plotting data from certain configurations of the ID7000 and Aurora. Please note that FCS 3.2 files from the S8 and A8 cytometers are not fully supported in flowCore. You may receive warnings, but things should still work.</p>
<p>If you want to use data from another cytometer and are wiling to provide files for establishing the workflow, contact the author/maintainer.</p>
<p>This work has received funding from the KU Leuven C1 program, the European Union’s Horizon 2020 research and innovation programme under grant agreement No 874707 (EXIMIOUS), Wellcome Investigator Award, 222442/A/21/Z and UKRI Proactive Vaccinology Award, MR/Y004450/1 (IMMPROVE).</p>
<p>AutoSpectral is provided under a GPL3 licence for academic use. If you wish to use AutoSpectral in a non-academic setting, please contact Adrian Liston regarding licencing options.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install the development version of AutoSpectral from <a href="https://github.com/" class="external-link">GitHub</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Optional: Install Bioconductor packages</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"BiocManager"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"BiocManager"</span><span class="op">)</span></span>
<span><span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://bioconductor.github.io/BiocManager/reference/install.html" class="external-link">install</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"flowWorkspace"</span>, <span class="st">"flowCore"</span>, <span class="st">"PeacoQC"</span>, <span class="st">"Biobase"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># You'll need devtools or remotes to install from GitHub.</span></span>
<span><span class="co"># install.packages("devtools")</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"DrCytometer/AutoSpectral"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>This is a basic example of the workflow, using samples from the ID7000:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span> <span class="va"><a href="https://github.com/DrCytometer/AutoSpectral" class="external-link">AutoSpectral</a></span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Define the location of the single-stained control files.</span></span>
<span><span class="va">control.dir</span> <span class="op">&lt;-</span> <span class="st">"./Cell controls"</span></span>
<span></span>
<span><span class="co"># Get the parameters for your cytometer.</span></span>
<span><span class="co"># Supported cytometers include "aurora", "id7000", "a8", "s8" and "opteon".</span></span>
<span><span class="va">asp</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get.autospectral.param.html">get.autospectral.param</a></span><span class="op">(</span> cytometer <span class="op">=</span> <span class="st">"id7000"</span>, figures <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Optionally, create a control file (see article on this).</span></span>
<span><span class="co"># After creating it, manually edit to ensure it is correct.</span></span>
<span><span class="fu"><a href="reference/create.control.file.html">create.control.file</a></span><span class="op">(</span> <span class="va">control.dir</span>, <span class="va">asp</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Locate the edited control file.</span></span>
<span><span class="va">control.def.file</span> <span class="op">&lt;-</span> <span class="st">"fcs_control_file.csv"</span></span>
<span></span>
<span><span class="co"># check the control file for errors</span></span>
<span><span class="va">control.file.errors</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/check.control.file.html">check.control.file</a></span><span class="op">(</span> <span class="va">control.dir</span>, <span class="va">control.def.file</span>, <span class="va">asp</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">## Adjustments to automated gating</span></span>
<span><span class="co"># This will be covered more extensively elsewhere.</span></span>
<span><span class="co"># in this case, the cells on scatter are very small, so we modify the target.</span></span>
<span><span class="va">asp</span><span class="op">$</span><span class="va">gate.bound.density.max.target.cells</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="co"># Load the control files, gate, prepare for spectral extraction.</span></span>
<span><span class="co"># This is usually the slowest step.</span></span>
<span><span class="va">flow.control</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/define.flow.control.html">define.flow.control</a></span><span class="op">(</span> <span class="va">control.dir</span>, <span class="va">control.def.file</span>, <span class="va">asp</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># For speed and accuracy, the recommended approach is to clean the controls</span></span>
<span><span class="co"># using separate (universal) negative samples for both beads and cells.</span></span>
<span><span class="co"># In doing so, we select cells with matching autofluorescent background and</span></span>
<span><span class="co"># restrict the calculations to the brightest events.</span></span>
<span><span class="va">flow.control</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/clean.controls.html">clean.controls</a></span><span class="op">(</span> <span class="va">flow.control</span>, <span class="va">asp</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract the clean spectra</span></span>
<span><span class="va">univ.neg.spectra</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get.fluorophore.spectra.html">get.fluorophore.spectra</a></span><span class="op">(</span> <span class="va">flow.control</span>, <span class="va">asp</span>,  </span>
<span>                                             use.clean.expr <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                              title <span class="op">=</span> <span class="st">"Universal Negative Cells"</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># By default AutoSpectral extracts autofluorescence as a spectrum.</span></span>
<span><span class="co"># This is comparable to "Autofluorescence as a Fluorescent Tag" in SpectroFlo</span></span>
<span><span class="co"># More on this later.</span></span>
<span><span class="co"># To remove this AF parameter for unmixing:</span></span>
<span><span class="va">no.af.spectra</span> <span class="op">&lt;-</span> <span class="va">univ.neg.spectra</span><span class="op">[</span> <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span> <span class="va">univ.neg.spectra</span> <span class="op">)</span> <span class="op">==</span> <span class="st">"AF"</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co">## Unmixing</span></span>
<span><span class="co"># Set the location of the raw files to be unmixed.</span></span>
<span><span class="va">sample.dir</span> <span class="op">&lt;-</span> <span class="st">"./Raw samples"</span></span>
<span></span>
<span><span class="co"># Perform unmixing, here we will unmix all fcs files in the folder using </span></span>
<span><span class="co"># Weighted least squares (WLS or in Sony lingo, WLSM).</span></span>
<span><span class="fu"><a href="reference/unmix.folder.html">unmix.folder</a></span><span class="op">(</span> <span class="va">sample.dir</span>, <span class="va">no.af.spectra</span>, <span class="va">asp</span>, <span class="va">flow.control</span>, method <span class="op">=</span> <span class="st">"WLS"</span> <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="go-faster">Go Faster<a class="anchor" aria-label="anchor" href="#go-faster"></a>
</h2>
<p>R is not known for its speed.</p>
<p>For faster processing there are three things you can do, hopefully all fairly easy.</p>
<p>First, upgrade the BLAS and LAPACK libraries used by R. These provide algorithms for linear algebra, which is the heart of spectral unmixing. Simply swapping out your .dll files as in this tutorial can give speed ups of 5x. <a href="https://github.com/david-cortes/R-openblas-in-windows" class="external-link">Install OpenBLAS</a> All this involves is downloading the files from the internet, placing them in the right folder and doing a quick restart.</p>
<p>Do not set multiple threads for the BLAS as this will conflict with higher level parallelization, either in AutoSpectral or other packages.</p>
<p><a href="https://csantill.github.io/RPerformanceWBLAS/" class="external-link">More on fast BLAS</a></p>
<p>Second, install AutoSpectralRcpp. This is fully accessible from R and integrates with AutoSpectral. But, when it gets to the slow bits in the unmixing, it switches over to calculating in C++, so it can be 10-100x faster.</p>
<p><a href="https://github.com/DrCytometer/AutoSpectralRcpp" class="external-link">AutoSpectralRcpp</a></p>
<p>You can install the development version of AutoSpectralRcpp like so:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"DrCytometer/AutoSpectralRcpp"</span><span class="op">)</span></span></code></pre></div>
<p>Third, turn on parallel processing in AutoSpectral and AutoSpectralRcpp. At the moment, this is not fully optimized in AutoSpectral. The parallel processing in AutoSpectralRcpp operates via OpenMP and works well.</p>
<p>To activate parallel processing, either set the <code>parallel</code> flag to <code>TRUE</code> in <code>asp</code> or check the function arguments for a <code>parallel</code> option. Sorry, this will be cleaned up soon.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">asp</span><span class="op">$</span><span class="va">parallel</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span></code></pre></div>
<p>For unmixing larger data sets, you will do well to use a machine with more CPUs. Suggestions for faster processing are welcome. Some modest improvements are in the works.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/DrCytometer/AutoSpectral/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/DrCytometer/AutoSpectral/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small>GPL (&gt;= 3) + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing AutoSpectral</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Oliver Burton <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0003-3884-7373" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
<li>Carlos P. Roca <br><small class="roles"> Author </small> <a href="https://orcid.org/0000-0003-0230-1926" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
</ul>
</div>



  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Oliver Burton, Carlos P. Roca.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
