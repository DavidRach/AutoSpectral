# unmix_poisson.r

#' @title Unmix Using Poisson Regression
#'
#' @description This function performs unmixing of raw data using Poisson regression,
#'     with iterative reweighted least squares (IRLS) and fallback methods for
#'     cells that fail to converge.
#'
#' @importFrom stats glm.fit glm.control poisson coef
#' @importFrom future plan multisession
#' @importFrom future.apply future_lapply
#'
#' @param raw.data Matrix containing raw data to be unmixed.
#' @param spectra Matrix containing spectra information.
#' @param asp The AutoSpectral parameter list. Prepare using get.autospectral.param.
#'
#' @return A matrix containing the unmixed data.
#' @export


unmix.poisson <- function( raw.data, spectra, asp ) {

  # initialize with WLS unmixing (approximates Poisson weighting)
  unmixed.data <- unmix.wls( raw.data, spectra )

  # handle zeros and negative values
  spectra.t <- t( abs( spectra ) )
  spectra.t[ spectra.t <= 0 ] <- 1e-6
  raw.data[ raw.data <= 0 ] <- 1e-6
  unmixed.data[ unmixed.data <= 0 ] <- 1e-6

  # set up parallel processing
  if ( asp$parallel ){
    future::plan( future::multisession, workers = asp$worker.process.n )
    options( future.globals.maxSize = asp$max.memory.n )
    lapply.function <- future.apply::future_lapply
  } else {
    lapply.function <- lapply.sequential
  }

  unmixed.data <- lapply.function( 1:nrow( raw.data ), function( cell ) {
    raw.data.cell <- raw.data[ cell, ]
    unmixed.data.cell <- unmixed.data[ cell, ]

    # fit glm model with Poisson distribution using identity link function
    fit <- tryCatch(
      suppressWarnings(
        glm.fit( spectra.t, raw.data.cell,
                 start = unmixed.data.cell,
                 family = poisson( link = "identity" ),
                 control = glm.control( maxit = asp$rlm.iter.max ),
                 intercept = FALSE
             )
      )
    )

    if ( !inherits( fit, "try-error" ) && fit$converged )
      unmixed.data[ cell, ] <- coef( fit )
    else
      unmixed.data[ cell, ] <- unmixed.data.cell
  })

  unmixed.data <- do.call( rbind, unmixed.data )

  colnames( unmixed.data ) <- rownames( spectra )

  return( unmixed.data )
}
